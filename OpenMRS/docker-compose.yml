services:
  # OpenMRS Application Server
  openmrs:
    image: openmrs/openmrs-reference-application-distro:latest
    container_name: openmrs_server
    restart: always
    environment:
      - DB_HOST=openmrs_db
      - DB_DATABASE=openmrs
      - DB_USERNAME=openmrs
      - DB_PASSWORD=openmrs
      - DB_CREATE_TABLES=true
      - DB_AUTO_UPDATE=true
    depends_on:
      - openmrs_db
    ports:
      - "8080:8080"
    volumes:
      - openmrs_data:/openmrs/data

  # MySQL Database for OpenMRS
  openmrs_db:
    image: mysql:8.0
    container_name: openmrs_database
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=openmrs
      - MYSQL_USER=openmrs
      - MYSQL_PASSWORD=openmrs
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - openmrs_db_data:/var/lib/mysql
    ports:
      - "3306:3306"

  # Nginx Reverse Proxy for HTTPS
  nginx_proxy:
    image: nginx:stable-alpine
    container_name: openmrs_nginx_proxy
    restart: always
    ports:
      - "8443:443"
      - "8081:8080"
    depends_on:
      - openmrs
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/certs:/etc/nginx/certs:ro

volumes:
  openmrs_data:
  openmrs_db_data:
